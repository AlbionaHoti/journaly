# Migration `20201218045952-add-post-comment-subscription-table`

This migration has been generated by Robin MacPherson at 12/17/2020, 8:59:52 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "PostCommentSubscription" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "userId" INTEGER NOT NULL,
    "postId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "PostCommentSubscription.userId_postId_unique" ON "PostCommentSubscription"("userId", "postId")

ALTER TABLE "PostCommentSubscription" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "PostCommentSubscription" ADD FOREIGN KEY("postId")REFERENCES "Post"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Data Migration

Data migrations detail how to bring the database into an application-level consistent state after the structural changes have been applied through `npm run migrate:up`. They currently need to be applied manually, and should be applied promptly after the structural migration is applied.

```sql
-- Subscribe participants in PostComments of a Post to that post for future comments
INSERT INTO "PostCommentSubscription" ("userId", "postId", "createdAt") (
  SELECT "authorId" AS "userId", "postId", NOW() AS "createdAt"
  FROM "PostComment"
  GROUP BY "userId", "postId"
) ON CONFLICT DO NOTHING;

-- Subscribe post authors to all PostComments on their Posts
INSERT INTO "PostCommentSubscription" ("userId", "postId", "createdAt") (
  SELECT "Post"."authorId", "PostComment"."id", NOW()
  FROM "PostComment"
  JOIN "Post" ON "PostComment"."postId" = "Post"."id"
) ON CONFLICT DO NOTHING;
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201209170034-change-social-media-model..20201218045952-add-post-comment-subscription-table
--- datamodel.dml
+++ datamodel.dml
@@ -1,56 +1,57 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator prisma_client {
   provider = "prisma-client-js"
 }
 model User {
-  id                  Int                  @default(autoincrement()) @id
-  name                String?
-  email               String               @unique
-  handle              String               @unique
-  auth                Auth?
-  userRole            UserRole             @default(FREE_USER)
-  bio                 String?
-  posts               Post[]
-  subscription        UserSubscription?
-  socialMedia         SocialMedia?
-  location            Location?            @relation(fields: [locationId], references: [id])
-  locationId          Int?
-  languagesNative     LanguageNative[]
-  languagesLearning   LanguageLearning[]
-  languages           LanguageRelation[]
-  createdAt           DateTime             @default(now())
-  updatedAt           DateTime             @updatedAt
-  userInterests       UserInterest[]
-  pageView            PageView[]
-  profileImage        String?
-  threadSubscriptions ThreadSubscription[]
-  postLikes           PostLike[]
-  commentThanks       CommentThanks[]
-  postCommentThanks   PostCommentThanks[]
-  comments            Comment[]
-  postComments        PostComment[]
-  badges              UserBadge[]
-  followedBy          User[]               @relation("UserFollows", references: [id])
-  following           User[]               @relation("UserFollows", references: [id])
+  id                       Int                       @id @default(autoincrement())
+  name                     String?
+  email                    String                    @unique
+  handle                   String                    @unique
+  auth                     Auth?
+  userRole                 UserRole                  @default(FREE_USER)
+  bio                      String?
+  posts                    Post[]
+  subscription             UserSubscription?
+  socialMedia              SocialMedia?
+  location                 Location?                 @relation(fields: [locationId], references: [id])
+  locationId               Int?
+  languagesNative          LanguageNative[]
+  languagesLearning        LanguageLearning[]
+  languages                LanguageRelation[]
+  createdAt                DateTime                  @default(now())
+  updatedAt                DateTime                  @updatedAt
+  userInterests            UserInterest[]
+  pageView                 PageView[]
+  profileImage             String?
+  threadSubscriptions      ThreadSubscription[]
+  postLikes                PostLike[]
+  commentThanks            CommentThanks[]
+  postCommentThanks        PostCommentThanks[]
+  comments                 Comment[]
+  postComments             PostComment[]
+  badges                   UserBadge[]
+  followedBy               User[]                    @relation("UserFollows", references: [id])
+  following                User[]                    @relation("UserFollows", references: [id])
+  postCommentSubscriptions PostCommentSubscription[]
 }
 model Auth {
-  id               Int     @default(autoincrement()) @id
+  id               Int     @id @default(autoincrement())
   user             User    @relation(fields: [userId], references: [id])
   userId           Int     @unique
   password         String
   resetToken       String?
   resetTokenExpiry Int?
 }
 model LanguageLearning {
-  id         Int      @default(autoincrement()) @id
+  id         Int      @id @default(autoincrement())
   user       User     @relation(fields: [userId], references: [id])
   userId     Int
   language   Language @relation(fields: [languageId], references: [id])
   languageId Int
@@ -59,15 +60,16 @@
   @@unique([userId, languageId])
 }
 model LanguageRelation {
-  id         Int      @default(autoincrement()) @id
-  user       User     @relation(fields: [userId], references: [id])
+  id         Int           @id @default(autoincrement())
+  user       User          @relation(fields: [userId], references: [id])
   userId     Int
-  language   Language @relation(fields: [languageId], references: [id])
+  language   Language      @relation(fields: [languageId], references: [id])
   languageId Int
-  createdAt  DateTime @default(now())
+  createdAt  DateTime      @default(now())
   level      LanguageLevel
+
   @@unique([userId, languageId])
 }
 enum LanguageLevel {
@@ -77,9 +79,9 @@
   NATIVE
 }
 model LanguageNative {
-  id         Int      @default(autoincrement()) @id
+  id         Int      @id @default(autoincrement())
   user       User     @relation(fields: [userId], references: [id])
   userId     Int
   language   Language @relation(fields: [languageId], references: [id])
   languageId Int
@@ -88,70 +90,72 @@
   @@unique([userId, languageId])
 }
 model SocialMedia {
-  id         Int      @default(autoincrement()) @id
-  user       User     @relation(fields: [userId], references: [id])
-  userId     Int      @unique
-  website    String
-  youtube    String
-  instagram  String
-  facebook   String
+  id        Int    @id @default(autoincrement())
+  user      User   @relation(fields: [userId], references: [id])
+  userId    Int    @unique
+  website   String
+  youtube   String
+  instagram String
+  facebook  String
 }
 model Post {
-  id           Int           @default(autoincrement()) @id
-  title        String
-  body         String
-  bodySrc      String        @default("")
-  excerpt      String
-  status       PostStatus    @default(DRAFT)
-  images       Image[]
-  createdAt    DateTime      @default(now())
-  updatedAt    DateTime      @updatedAt
-  publishedAt  DateTime?
-  author       User          @relation(fields: [authorId], references: [id])
-  authorId     Int
-  readTime     Int           @default(1)
-  likes        PostLike[]
-  language     Language      @relation(fields: [languageId], references: [id])
-  languageId   Int
-  longitude    Float?
-  latitude     Float?
-  threads      Thread[]
-  postTopics   PostTopic[]
-  postComments PostComment[]
+  id                       Int                       @id @default(autoincrement())
+  title                    String
+  body                     String
+  bodySrc                  String                    @default("")
+  excerpt                  String
+  status                   PostStatus                @default(DRAFT)
+  images                   Image[]
+  createdAt                DateTime                  @default(now())
+  updatedAt                DateTime                  @updatedAt
+  publishedAt              DateTime?
+  author                   User                      @relation(fields: [authorId], references: [id])
+  authorId                 Int
+  readTime                 Int                       @default(1)
+  likes                    PostLike[]
+  language                 Language                  @relation(fields: [languageId], references: [id])
+  languageId               Int
+  longitude                Float?
+  latitude                 Float?
+  threads                  Thread[]
+  postTopics               PostTopic[]
+  postComments             PostComment[]
+  postCommentSubscriptions PostCommentSubscription[]
 }
 model Language {
-  id            Int                @default(autoincrement()) @id
+  id            Int                @id @default(autoincrement())
   posts         Post[]
   name          String
   dialect       String?
   nativeUsers   LanguageNative[]
   learningUsers LanguageLearning[]
+  LanguageRelation LanguageRelation[]
   @@unique([name, dialect])
 }
 model Location {
-  id      Int    @default(autoincrement()) @id
+  id      Int    @id @default(autoincrement())
   country String
   city    String
   User    User[]
 }
 model Topic {
-  id                Int                @default(autoincrement()) @id
+  id                Int                @id @default(autoincrement())
   devName           String
   userInterests     UserInterest[]
   postTopics        PostTopic[]
   prompt            Prompt[]
   topicTranslations TopicTranslation[]
 }
 model TopicTranslation {
-  id         Int        @default(autoincrement()) @id
+  id         Int        @id @default(autoincrement())
   uiLanguage UILanguage
   name       String
   topic      Topic      @relation(fields: [topicId], references: [id])
   topicId    Int
@@ -159,9 +163,9 @@
   @@unique([uiLanguage, topicId])
 }
 model UserInterest {
-  id        Int      @default(autoincrement()) @id
+  id        Int      @id @default(autoincrement())
   user      User     @relation(fields: [userId], references: [id])
   userId    Int
   topic     Topic    @relation(fields: [topicId], references: [id])
   topicId   Int
@@ -170,9 +174,9 @@
   @@unique([userId, topicId])
 }
 model PostTopic {
-  id      Int   @default(autoincrement()) @id
+  id      Int   @id @default(autoincrement())
   post    Post  @relation(fields: [postId], references: [id])
   postId  Int
   topic   Topic @relation(fields: [topicId], references: [id])
   topicId Int
@@ -180,39 +184,42 @@
   @@unique([postId, topicId])
 }
 model PostLike {
-  id        Int      @default(autoincrement()) @id
+  id        Int      @id @default(autoincrement())
   createdAt DateTime @default(now())
   author    User     @relation(fields: [authorId], references: [id])
   authorId  Int
   post      Post     @relation(fields: [postId], references: [id])
   postId    Int
+
   @@unique([authorId, postId])
 }
 model CommentThanks {
-  id        Int      @default(autoincrement()) @id
+  id        Int      @id @default(autoincrement())
   createdAt DateTime @default(now())
   author    User     @relation(fields: [authorId], references: [id])
   authorId  Int
   comment   Comment  @relation(fields: [commentId], references: [id])
   commentId Int
+
   @@unique([authorId, commentId])
 }
 model PostCommentThanks {
-  id            Int          @default(autoincrement()) @id
+  id            Int          @id @default(autoincrement())
   createdAt     DateTime     @default(now())
   author        User         @relation(fields: [authorId], references: [id])
   authorId      Int
   PostComment   PostComment? @relation(fields: [postCommentId], references: [id])
   postCommentId Int?
+
   @@unique([authorId, postCommentId])
 }
 model Comment {
-  id        Int             @default(autoincrement()) @id
+  id        Int             @id @default(autoincrement())
   createdAt DateTime        @default(now())
   updatedAt DateTime        @updatedAt
   body      String
   author    User            @relation(fields: [authorId], references: [id])
@@ -222,9 +229,9 @@
   thanks    CommentThanks[]
 }
 model PostComment {
-  id        Int                 @default(autoincrement()) @id
+  id        Int                 @id @default(autoincrement())
   createdAt DateTime            @default(now())
   updatedAt DateTime            @updatedAt
   body      String
   author    User                @relation(fields: [authorId], references: [id])
@@ -234,9 +241,9 @@
   thanks    PostCommentThanks[]
 }
 model Thread {
-  id                 Int                  @default(autoincrement()) @id
+  id                 Int                  @id @default(autoincrement())
   startIndex         Int
   endIndex           Int
   archived           Boolean              @default(false)
   highlightedContent String
@@ -246,35 +253,47 @@
   subscriptions      ThreadSubscription[]
 }
 model Image {
-  id        Int       @default(autoincrement()) @id
+  id        Int       @id @default(autoincrement())
   smallSize String
   largeSize String
   imageRole ImageRole
   post      Post?     @relation(fields: [postId], references: [id])
   postId    Int?
 }
 model Prompt {
-  id      Int    @default(autoincrement()) @id
+  id      Int    @id @default(autoincrement())
   text    String
   topic   Topic  @relation(fields: [topicId], references: [id])
   topicId Int
 }
 model ThreadSubscription {
-  id        Int      @default(autoincrement()) @id
+  id        Int      @id @default(autoincrement())
   createdAt DateTime @default(now())
   user      User     @relation(fields: [userId], references: [id])
   userId    Int
   thread    Thread   @relation(fields: [threadId], references: [id])
   threadId  Int
+
   @@unique([userId, threadId])
 }
+model PostCommentSubscription {
+  id        Int      @id @default(autoincrement())
+  createdAt DateTime @default(now())
+  user      User     @relation(fields: [userId], references: [id])
+  userId    Int
+  post      Post     @relation(fields: [postId], references: [id])
+  postId    Int
+
+  @@unique([userId, postId])
+}
+
 model UserSubscription {
-  id        Int      @default(autoincrement()) @id
+  id        Int      @id @default(autoincrement())
   name      String
   price     Int
   user      User     @relation(fields: [userId], references: [id])
   userId    Int
@@ -282,9 +301,9 @@
   updatedAt DateTime @updatedAt
 }
 model PageView {
-  id                  Int      @default(autoincrement()) @id
+  id                  Int      @id @default(autoincrement())
   user                User?    @relation(fields: [userId], references: [id])
   userId              Int?
   sessionId           String
   pageName            String
@@ -295,13 +314,14 @@
   user_agent_language String
 }
 model UserBadge {
-  id        Int       @default(autoincrement()) @id
+  id        Int       @id @default(autoincrement())
   type      BadgeType
   createdAt DateTime  @default(now())
   user      User      @relation(fields: [userId], references: [id])
   userId    Int
+
   @@unique([userId, type])
 }
 enum UserRole {
```
