# Migration `20200908095206-add-thanks-and-db-constraints`

This migration has been generated by Robin MacPherson at 9/8/2020, 9:52:06 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."CommentThanks" (
"authorId" integer  NOT NULL ,"commentId" integer  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."PostCommentThanks" (
"authorId" integer  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"postCommentId" integer   ,
    PRIMARY KEY ("id"))

ALTER TABLE "public"."Post" ALTER COLUMN "status" SET DEFAULT 'DRAFT';

ALTER TABLE "public"."PostLike" DROP CONSTRAINT IF EXiSTS "PostLike_userId_fkey",
DROP COLUMN "userId",
ADD COLUMN "authorId" integer  NOT NULL ;

ALTER TABLE "public"."User" ALTER COLUMN "userRole" SET DEFAULT 'FREE_USER';

ALTER TABLE "public"."CommentLike" DROP CONSTRAINT IF EXiSTS "CommentLike_commentId_fkey";

ALTER TABLE "public"."CommentLike" DROP CONSTRAINT IF EXiSTS "CommentLike_userId_fkey";

ALTER TABLE "public"."PostCommentLike" DROP CONSTRAINT IF EXiSTS "PostCommentLike_postCommentId_fkey";

ALTER TABLE "public"."PostCommentLike" DROP CONSTRAINT IF EXiSTS "PostCommentLike_userId_fkey";

CREATE UNIQUE INDEX "CommentThanks.authorId_commentId" ON "public"."CommentThanks"("authorId","commentId")

CREATE UNIQUE INDEX "PostCommentThanks.authorId_postCommentId" ON "public"."PostCommentThanks"("authorId","postCommentId")

CREATE UNIQUE INDEX "PostLike.authorId_postId" ON "public"."PostLike"("authorId","postId")

ALTER TABLE "public"."CommentThanks" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."CommentThanks" ADD FOREIGN KEY ("commentId")REFERENCES "public"."Comment"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PostCommentThanks" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PostCommentThanks" ADD FOREIGN KEY ("postCommentId")REFERENCES "public"."PostComment"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."PostLike" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

DROP TABLE "public"."CommentLike";

DROP TABLE "public"."PostCommentLike";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200816171330-add-thread-subscription-table..20200908095206-add-thanks-and-db-constraints
--- datamodel.dml
+++ datamodel.dml
@@ -1,39 +1,40 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
 generator prisma_client {
   provider = "prisma-client-js"
 }
 model User {
-  id                Int                @default(autoincrement()) @id
-  name              String?
-  email             String             @unique
-  handle            String             @unique
-  auth              Auth?
-  userRole          UserRole           @default(FREE_USER)
-  bio               String?
-  posts             Post[]
-  subscription      UserSubscription?
-  socialMedia       SocialMedia[]
-  interests         Topic[]
-  location          Location?          @relation(fields: [locationId], references: [id])
-  locationId        Int?
-  languagesNative   LanguageNative[]
-  languagesLearning LanguageLearning[]
-  createdAt         DateTime           @default(now())
-  updatedAt         DateTime           @updatedAt
-  userInterests     UserInterest[]
-  postLike          PostLike[]
-  commentLike       CommentLike[]
-  pageView          PageView[]
-  profileImage      String?
-  comment           Comment[]
-  PostCommentLike   PostCommentLike[]
-  PostComment       PostComment[]
+  id                  Int                  @default(autoincrement()) @id
+  name                String?
+  email               String               @unique
+  handle              String               @unique
+  auth                Auth?
+  userRole            UserRole             @default(FREE_USER)
+  bio                 String?
+  posts               Post[]
+  subscription        UserSubscription?
+  socialMedia         SocialMedia[]
+  interests           Topic[]
+  location            Location?            @relation(fields: [locationId], references: [id])
+  locationId          Int?
+  languagesNative     LanguageNative[]
+  languagesLearning   LanguageLearning[]
+  createdAt           DateTime             @default(now())
+  updatedAt           DateTime             @updatedAt
+  userInterests       UserInterest[]
+  pageView            PageView[]
+  profileImage        String?
+  threadSubscriptions ThreadSubscription[]
+  postLikes           PostLike[]
+  commentThanks       CommentThanks[]
+  postCommentThanks   PostCommentThanks[]
+  comments            Comment[]
+  postComments        PostComment[]
 }
 model Auth {
   id               Int       @default(autoincrement()) @id
@@ -151,62 +152,65 @@
 model PostLike {
   id        Int      @default(autoincrement()) @id
   createdAt DateTime @default(now())
-  author    User     @relation(fields: [userId], references: [id])
-  userId    Int
+  author    User     @relation(fields: [authorId], references: [id])
+  authorId  Int
   post      Post     @relation(fields: [postId], references: [id])
   postId    Int
+  @@unique([authorId, postId])
 }
-model CommentLike {
+model CommentThanks {
   id        Int      @default(autoincrement()) @id
   createdAt DateTime @default(now())
-  author    User     @relation(fields: [userId], references: [id])
-  userId    Int
+  author    User     @relation(fields: [authorId], references: [id])
+  authorId  Int
   comment   Comment  @relation(fields: [commentId], references: [id])
   commentId Int
+  @@unique([authorId, commentId])
 }
-model PostCommentLike {
+model PostCommentThanks {
   id            Int          @default(autoincrement()) @id
   createdAt     DateTime     @default(now())
-  author        User         @relation(fields: [userId], references: [id])
-  userId        Int
+  author        User         @relation(fields: [authorId], references: [id])
+  authorId      Int
   PostComment   PostComment? @relation(fields: [postCommentId], references: [id])
   postCommentId Int?
+  @@unique([authorId, postCommentId])
 }
 model Comment {
-  id        Int           @default(autoincrement()) @id
-  createdAt DateTime      @default(now())
-  updatedAt DateTime      @updatedAt
+  id        Int             @default(autoincrement()) @id
+  createdAt DateTime        @default(now())
+  updatedAt DateTime        @updatedAt
   body      String
-  author    User          @relation(fields: [authorId], references: [id])
+  author    User            @relation(fields: [authorId], references: [id])
   authorId  Int
-  thread    Thread        @relation(fields: [threadId], references: [id])
+  thread    Thread          @relation(fields: [threadId], references: [id])
   threadId  Int
-  likes     CommentLike[]
+  thanks    CommentThanks[]
 }
 model PostComment {
-  id        Int               @default(autoincrement()) @id
-  createdAt DateTime          @default(now())
-  updatedAt DateTime          @updatedAt
+  id        Int                 @default(autoincrement()) @id
+  createdAt DateTime            @default(now())
+  updatedAt DateTime            @updatedAt
   body      String
-  author    User              @relation(fields: [authorId], references: [id])
+  author    User                @relation(fields: [authorId], references: [id])
   authorId  Int
-  post      Post              @relation(fields: [postId], references: [id])
+  post      Post                @relation(fields: [postId], references: [id])
   postId    Int
-  likes     PostCommentLike[]
+  thanks    PostCommentThanks[]
 }
 model Thread {
-  id                 Int       @default(autoincrement()) @id
+  id                 Int                  @default(autoincrement()) @id
   startIndex         Int
   endIndex           Int
   highlightedContent String
-  post               Post      @relation(fields: [postId], references: [id])
+  post               Post                 @relation(fields: [postId], references: [id])
   postId             Int
   comments           Comment[]
   subscriptions      ThreadSubscription[]
 }
```


