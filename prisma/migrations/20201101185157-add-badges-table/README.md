# Migration `20201101185157-add-badges-table`

This migration has been generated by Ryan "Lanny" Jenkins at 11/1/2020, 6:51:57 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."UserBadge" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"type" "BadgeType" NOT NULL ,"userId" integer  NOT NULL ,
    PRIMARY KEY ("id"))

ALTER TABLE "public"."Post" ALTER COLUMN "status" SET DEFAULT 'DRAFT';

ALTER TABLE "public"."User" ALTER COLUMN "userRole" SET DEFAULT 'FREE_USER';

CREATE UNIQUE INDEX "UserBadge.userId_type" ON "public"."UserBadge"("userId","type")

ALTER TABLE "public"."UserBadge" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

# Data Migration

```
INSERT INTO "UserBadge" ("userId", "type") (
  SELECT "User".id AS "userId", 'ALPHA_USER' as "type" FROM "User"
  JOIN "Post" ON "Post"."authorId" = "User"."id"
  WHERE "User"."id" < 143
  GROUP BY "userId"
  HAVING COUNT(*) > 0
) ON CONFLICT DO NOTHING;

INSERT INTO "UserBadge" ("userId", "type") (
  SELECT "User".id AS "userId", 'BETA_USER' as "type" FROM "User"
  FULL OUTER JOIN "UserBadge" ON
    "UserBadge"."userId" = "User"."id"
    AND "UserBadge".type = 'ALPHA_USER'
  WHERE
    "UserBadge".type IS NULL
    AND "User"."id" > 143
) ON CONFLICT DO NOTHING;
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201026144537-new-language-relation-model..20201101185157-add-badges-table
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
 generator prisma_client {
   provider = "prisma-client-js"
@@ -33,8 +33,9 @@
   commentThanks       CommentThanks[]
   postCommentThanks   PostCommentThanks[]
   comments            Comment[]
   postComments        PostComment[]
+  badges              UserBadge[]
   followedBy          User[]               @relation("UserFollows", references: [id])
   following           User[]               @relation("UserFollows", references: [id])
 }
@@ -291,8 +292,17 @@
   user_agent_string   String
   user_agent_language String
 }
+model UserBadge {
+  id        Int       @default(autoincrement()) @id
+  type      BadgeType
+  createdAt DateTime  @default(now())
+  user      User      @relation(fields: [userId], references: [id])
+  userId    Int
+  @@unique([userId, type])
+}
+
 enum UserRole {
   ADMIN
   MODERATOR
   FREE_USER
@@ -319,4 +329,10 @@
 enum UILanguage {
   ENGLISH
   GERMAN
 }
+
+enum BadgeType {
+  ALPHA_USER
+  BETA_USER
+  ONEHUNDRED_POSTS
+}
```


